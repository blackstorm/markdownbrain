<!DOCTYPE html>
<html lang="en" data-theme="wireframe">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site Management - MarkdownBrain</title>

    <!-- Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">

    <link href="/css/app.css" rel="stylesheet">
    <script src="/js/htmx.min.js"></script>
    <style>
        /* HTMX loading indicators */
        .htmx-indicator {
            display: none;
        }
        .htmx-request .htmx-indicator {
            display: inline-block;
        }
        .htmx-request .delete-text,
        .htmx-request .submit-text {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen bg-base-200">
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-brand">Sites</h1>
                <p class="text-base-content/70 mt-2">Manage your published Obsidian vaults</p>
            </div>
            <button onclick="my_modal_create.showModal()"
                    class="btn btn-brand">
                <span class="material-symbols-outlined">add</span>
                New Site
            </button>
        </div>

        <!-- Site list -->
        <div hx-get="/admin/vaults"
             hx-trigger="load, refreshList from:body"
             hx-target="#vault-list"
             hx-swap="innerHTML">
            <div id="vault-list">
                <div class="flex justify-center py-12">
                    <span class="loading loading-spinner loading-lg"></span>
                </div>
            </div>
        </div>

        <!-- Create site modal -->
        <dialog id="my_modal_create" class="modal">
            <div class="modal-box">
                <form method="dialog">
                    <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
                </form>
                <h3 class="text-lg font-bold mb-4 text-brand">New Site</h3>

                <form hx-post="/admin/vaults"
                      hx-target="#create-result"
                      hx-swap="innerHTML"
                      class="space-y-4">

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Name</span>
                        </label>
                        <input type="text"
                               name="name"
                               required
                               class="input input-bordered w-full"
                               placeholder="My Digital Garden">
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Domain</span>
                        </label>
                        <input type="text"
                               name="domain"
                               required
                               class="input input-bordered w-full"
                               placeholder="notes.example.com">
                    </div>

                    <div id="create-result"></div>

                    <div class="modal-action">
                        <button type="submit" class="btn btn-brand">
                            <span class="htmx-indicator loading loading-spinner loading-sm"></span>
                            <span class="submit-text">Create Site</span>
                        </button>
                    </div>
                </form>
            </div>
            <form method="dialog" class="modal-backdrop">
                <button>close</button>
            </form>
        </dialog>
    </div>

    <!-- Footer -->
    <footer class="footer footer-center p-4 text-base-content/60 mt-8">
        <aside>
            <p>Powered by <a href="https://markdownbrain.com" target="_blank" class="link text-brand">MarkdownBrain</a></p>
        </aside>
    </footer>

    <script>
    // Process newly inserted HTMX attributes
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === 'vault-list') {
            htmx.process(evt.detail.target);
        }
    });

    // Refresh list after successful creation
    document.body.addEventListener('htmx:afterRequest', function(evt) {
        if (evt.detail.target.id === 'create-result' && evt.detail.successful) {
            const response = JSON.parse(evt.detail.xhr.responseText);
            if (response.success) {
                evt.detail.target.innerHTML = `
                    <div class="alert alert-success">
                        <span>Site created successfully!</span>
                    </div>
                `;
                setTimeout(function() {
                    my_modal_create.close();
                    const form = document.querySelector('#my_modal_create form[hx-post]');
                    if (form) form.reset();
                    evt.detail.target.innerHTML = '';
                    document.body.dispatchEvent(new Event('refreshList'));
                }, 1000);
            } else {
                evt.detail.target.innerHTML = `
                    <div class="alert alert-error">
                        <span>${response.error || 'Creation failed'}</span>
                    </div>
                `;
            }
        }
    });

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function() {
            alert('Copied to clipboard');
        });
    }

    function toggleKey(button) {
        const codeElement = button.previousElementSibling;
        const fullKey = codeElement.dataset.key;
        const isHidden = codeElement.textContent.includes('******');

        if (isHidden) {
            codeElement.textContent = fullKey;
        } else {
            codeElement.textContent = fullKey.substring(0, 8) + '******' + fullKey.substring(fullKey.length - 8);
        }
    }
    </script>
</body>
</html>
