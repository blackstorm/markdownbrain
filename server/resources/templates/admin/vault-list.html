{% if vaults|not-empty %}
  {% for vault in vaults %}
    {% include "templates/admin/components/vault-card.html" %}
  {% endfor %}
{% else %}
  {% with icon="inbox" title="No sites yet" message="Create your first site to start publishing your Obsidian notes to the web" cta-text="Create first site" cta-action="openCreateModal()" cta-icon="plus" grid-full=true %}
    {% include "templates/admin/components/empty-state.html" %}
  {% endwith %}
{% endif %}

<script>
function toggleActionMenu(button) {
    const menu = button.nextElementSibling;
    const isOpen = menu.classList.contains('open');
    document.querySelectorAll('.action-menu.open').forEach(m => m.classList.remove('open'));
    if (!isOpen) {
        menu.classList.add('open');
    }
}

document.addEventListener('click', function(e) {
    if (!e.target.closest('.vault-actions')) {
        document.querySelectorAll('.action-menu.open').forEach(m => m.classList.remove('open'));
    }
});

function toggleSyncKey(button, vaultId) {
    const keyElement = document.getElementById(`key-${vaultId}`);
    const fullKey = keyElement.dataset.key;
    const currentText = keyElement.textContent.trim();
    const isHidden = currentText.includes('*');
    const icon = button.querySelector('i');

    if (isHidden) {
        keyElement.textContent = fullKey;
        icon.setAttribute('data-lucide', 'eye-off');
        button.title = 'Hide';
    } else {
        const masked = fullKey.substring(0, 8) + '******' + fullKey.substring(fullKey.length - 8);
        keyElement.textContent = masked;
        icon.setAttribute('data-lucide', 'eye');
        button.title = 'Show';
    }
    lucide.createIcons();
}

function uploadLogo(input, vaultId) {
    const file = input.files[0];
    if (!file) return;

    const maxSize = 2 * 1024 * 1024;
    if (file.size > maxSize) {
        showNotification('File too large. Maximum size is 2MB.', 'error');
        return;
    }

    const allowedTypes = ['image/png', 'image/jpeg', 'image/gif', 'image/webp', 'image/svg+xml'];
    if (!allowedTypes.includes(file.type)) {
        showNotification('Invalid file type. Allowed: PNG, JPEG, GIF, WebP, SVG', 'error');
        return;
    }

    const formData = new FormData();
    formData.append('logo', file);

    fetch(`/admin/vaults/${vaultId}/logo`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Logo uploaded successfully', 'success');
            htmx.trigger('body', 'refreshList');
        } else {
            showNotification(data.error || 'Upload failed', 'error');
        }
    })
    .catch(err => {
        console.error('Logo upload error:', err);
        showNotification('Upload failed', 'error');
    });

    input.value = '';
}

function deleteLogo(vaultId) {
    if (!confirm('Are you sure you want to delete this logo?')) return;

    fetch(`/admin/vaults/${vaultId}/logo`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Logo deleted', 'success');
            htmx.trigger('body', 'refreshList');
        } else {
            showNotification(data.error || 'Delete failed', 'error');
        }
    })
    .catch(err => {
        console.error('Logo delete error:', err);
        showNotification('Delete failed', 'error');
    });
}
</script>
