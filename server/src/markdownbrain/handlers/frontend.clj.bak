(ns markdownbrain.handlers.frontend
  (:require [markdownbrain.db :as db]
            [markdownbrain.markdown :as md]
            [markdownbrain.response :as resp]
            [selmer.parser :as selmer]
            [clojure.string :as str]
            [ring.util.response :as response]))

;; 获取当前域名对应的 vault
(defn get-current-vault [request]
  (when-let [host (get-in request [:headers "host"])]
    (let [domain (first (clojure.string/split host #":"))]
      (db/get-vault-by-domain domain))))

;; 首页 - 显示 vault 信息
(defn home [request]
  (if-let [vault (get-current-vault request)]
    (let [documents (db/list-documents-by-vault (:id vault))]
      (resp/html (selmer/render-file "templates/frontend/home.html"
                                     {:vault vault
                                      :documents documents})))
    {:status 404
     :body "未找到站点"}))

;; API: 获取文档列表
(defn get-documents [request]
  (if-let [vault (get-current-vault request)]
    (resp/ok (db/list-documents-by-vault (:id vault)))
    (resp/not-found "Vault not found")))

;; API: 获取单个文档
(defn get-document [request]
  (let [doc-id (get-in request [:path-params :id])]
    (if-let [doc (db/get-document doc-id)]
      (resp/ok doc)
      (resp/not-found "Document not found"))))

;; ============================================================
;; 笔记展示（Andy Matuschak 滑动面板）
;; ============================================================

(defn- prepare-note-data
  "准备单个笔记的渲染数据

   返回: {:id :title :html-content :path :updated-at :backlinks}"
  [doc vault-id all-docs]
  (let [;; 渲染 Markdown
        html-content (md/render-markdown (:content doc) all-docs)
        ;; 提取标题
        title (or (md/extract-title (:content doc))
                  (-> (:path doc)
                      (str/replace #"\.md$" "")
                      (str/replace #"/" " / ")))
        ;; 获取反向链接
        backlinks (db/get-backlinks-with-docs vault-id (:client-id doc))
        ;; 为每个反向链接提取标题和描述
        backlinks-with-meta (mapv (fn [backlink]
                                    (assoc backlink
                                           :title (or (md/extract-title (:content backlink))
                                                      (str/replace (:path backlink) #"\.md$" ""))
                                           :description (when (:content backlink)
                                                          (let [lines (str/split-lines (:content backlink))
                                                                first-para (->> lines
                                                                                (drop-while #(str/starts-with? % "#"))
                                                                                (filter #(not (str/blank? %)))
                                                                                first)]
                                                            (when first-para
                                                              (subs first-para 0 (min 100 (count first-para))))))))
                                  backlinks)]
    {:note {:id (:id doc)
            :title title
            :html-content html-content
            :path (:path doc)
            :updated-at (:updated-at doc)}
     :backlinks backlinks-with-meta}))

(defn get-note
  "渲染笔记（支持滑动面板堆叠）

   URL 格式:
   - 根文档: / (无路径)
   - 单个笔记: /:id
   - 堆叠笔记: /:id?stacked=note-1&stacked=note-2

   功能:
   - 渲染 Markdown 内容为 HTML
   - 处理 Obsidian [[链接]]
   - 显示反向链接（Link to this note）
   - 支持多笔记堆叠展示
   - 自动显示 root document（如果未指定 ID）

   响应:
   - 如果是 HTMX 请求：返回单个 note.html 片段
   - 如果是普通请求：返回完整页面（包含所有堆叠的笔记）"
  [request]
  (let [;; 从 /*path 中提取路径
        raw-path (get-in request [:path-params :path])
        ;; 去掉前导斜杠得到 doc-id（如果为空则为 nil）
        doc-id (when (and raw-path (not (str/blank? raw-path)))
                 (str/replace raw-path #"^/" ""))
        ;; 获取 stacked 参数（可能是单个字符串或字符串数组）
        stacked-param (get-in request [:query-params "stacked"])
        stacked-ids (cond
                      (nil? stacked-param) []
                      (string? stacked-param) [stacked-param]
                      :else stacked-param)
        is-htmx? (get-in request [:headers "hx-request"])
        ;; 获取当前 vault
        vault (get-current-vault request)]

    (if-not vault
      ;; 未找到 vault
      {:status 404
       :body "未找到站点"}

      ;; 确定要显示的文档
      (let [target-doc (if doc-id
                         ;; 有 doc-id：直接查询
                         (db/get-document doc-id)
                         ;; 无 doc-id：显示 root document
                         (when-let [root-doc-id (:root-doc-id vault)]
                           (db/get-document root-doc-id)))]

        (if target-doc
          (let [vault-id (:vault-id target-doc)
                all-docs (db/list-documents-by-vault vault-id)]

            (if is-htmx?
              ;; HTMX 请求：只返回当前笔记片段
              (let [render-data (prepare-note-data target-doc vault-id all-docs)]
                (resp/html (selmer/render-file "templates/frontend/note.html" render-data)))

              ;; 普通请求：返回完整页面（包含堆叠的笔记）
              (let [;; 获取所有堆叠的笔记
                    stacked-docs (keep db/get-document stacked-ids)
                    ;; 为每个笔记准备渲染数据
                    stacked-notes-data (mapv #(prepare-note-data % vault-id all-docs) stacked-docs)
                    ;; 当前笔记数据
                    current-note-data (prepare-note-data target-doc vault-id all-docs)
                    ;; 所有笔记（堆叠的 + 当前的）
                    all-notes-data (conj stacked-notes-data current-note-data)]
                (resp/html (selmer/render-file "templates/frontend/note-page.html"
                                                {:notes all-notes-data})))))

          ;; 文档不存在（如果没有 root doc，则显示文档列表）
          (if (and (nil? doc-id) (nil? (:root-doc-id vault)))
            ;; 没有 root doc 且访问的是根路径：显示文档列表
            (let [documents (db/list-documents-by-vault (:id vault))]
              (resp/html (selmer/render-file "templates/frontend/home.html"
                                              {:vault vault
                                               :documents documents})))
            ;; 其他情况：文档不存在
            (if is-htmx?
              {:status 404
               :headers {"Content-Type" "text/html"}
               :body "<div class=\"note error\"><p>文档不存在</p></div>"}
              {:status 404
               :body "文档不存在"})))))))

;; 管理后台首页
(defn admin-home [request]
  (let [tenant-id (get-in request [:session :tenant-id])
        tenant (db/get-tenant tenant-id)
        vaults (db/list-vaults-by-tenant tenant-id)
        vaults-with-data (mapv (fn [vault]
                                 (let [sync-key (:sync-key vault)
                                       masked (str (subs sync-key 0 8) "******" (subs sync-key (- (count sync-key) 8)))
                                       documents (db/search-documents-by-vault (:id vault) "")]
                                   (assoc vault
                                          :masked-key masked
                                          :documents documents)))
                               vaults)]
    (resp/html (selmer/render-file "templates/admin/vaults.html"
                                    {:tenant tenant
                                     :vaults vaults-with-data}))))

;; 登录页面
(defn login-page [request]
  (resp/html (selmer/render-file "templates/admin/login.html" {})))

;; 初始化页面
(defn init-page [request]
  (resp/html (selmer/render-file "templates/admin/init.html" {})))
