1. 全量同步接口 /sync/changes（手动同步按钮）
客户端请求格式
POST /sync/changes
{
  "notes": [
    {"id": "xxxxx", "hash": "xxxx"}
  ],
  "assets": [
    {"id": "xxxx", "hash": "xxxx"}
  ]
}


说明：

notes 和 assets = 客户端当前完整快照

客户端不需要上报删除信息，服务端会根据快照差集自动判断删除

服务端处理逻辑

对比服务器记录和客户端快照：

如果服务端存在但客户端不存在 → 删除服务端文件

如果服务端不存在或 hash 不一致 → 标记为 need_upsert

删除操作在返回前立即执行，保证快照权威性

返回结果（不允许 null，空数组表示没有对应文件）

{
  "need_upsert": {
    "notes": [...],   // 包含 id + hash
    "assets": [...]   // 包含 id + hash
  },
  "deleted_on_server": {
    "notes": [...],   // 包含 id + hash
    "assets": [...]   // 包含 id + hash
  }
}

客户端同步操作

接收到 need_upsert 后执行上传：

notes → 单个请求上传到 POST /sync/notes

assets → 并发上传，最大并发数 3，上传到 POST /sync/assets

删除操作由服务端在 /sync/changes 内完成，客户端无需参与

---------------------------------

2. 单文件实时上传与删除（即时增量）

这一部分用于用户编辑文件后的及时更新，无需手动同步按钮

2.1 单文件更新
POST /sync/notes/{id}        # 单个 note 文件更新
POST /sync/assets/{id}       # 单个 asset 文件更新


如果文件不存在 → 创建

如果文件存在 → 覆盖（根据 hash 决定是否更新）

上传是即时的，不会触发其他文件删除

2.2 单文件删除（按引用计数删除）
DELETE /sync/notes/{note_id}/assets/{asset_id}


服务端存在多个引用（ref）：

删除该引用

只有当 ref 数量为 0 时，文件才真正删除

单文件删除仅删除目标文件，不影响其他文件或快照

实时删除是增量行为，全量同步仍然是快照权威

3 关键设计原则

快照优先：
/sync/changes 提交的快照总是权威，覆盖服务端状态

增量上传：
实时单文件上传只用于优化体验，不影响快照完整性

删除语义清晰：

快照同步删除多余文件

单文件删除按引用计数删除，保证资源安全

空数组代替 null：
所有返回字段使用空数组表示没有文件，避免解析歧义

可扩展性：
将来可支持多客户端同步、冲突检测或版本管理